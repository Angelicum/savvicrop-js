var Modernizr=Modernizer||false;if($(".img-container").length){function onCropSubmit(){$("body").trigger("onCropSubmit")}var state=document.getElementById("status"),$dropzone=document.getElementById("drop-zone"),$cropper,created=false,$filename="tmp",$previewThumb=$(".preview-thumb"),$previewCrop=$(".preview-crop"),$minimumWidth=320,$minimumHeight=110,uploadScript="/image-crop",CROP_DEBUG=false;function show(ele,fade){if(typeof fade==="undefined"||fade===null){fade=0}$(ele).removeClass("cloak");$(ele).show(fade)}function hide(ele,fade){if(typeof fade==="undefined"||fade===null){fade=0}$(ele).hide(fade)}function error(msg){$(".error-msg").text(msg);show("#error")}function gcd(a,b){return b==0?a:gcd(b,a%b)}var r=gcd($minimumWidth,$minimumHeight);var aspectRatio="auto";function setCropDimensions(w,h){if($cropper!=null){var e=$cropper.cropper("getData");var imageData=$cropper.cropper("getImageData");var cbd=$cropper.cropper("getCropBoxData");var rotate=Math.abs(imageData.rotate)===90;var ih,iw,nh,nw,scaleX,scaleY,newHeight,newWidth;if(rotate){ih=imageData.width;iw=imageData.height;nh=imageData.naturalWidth;nw=imageData.naturalHeight;scaleX=ih/nh;scaleY=iw/nw;newWidth=Math.round(w*scaleX);newHeight=Math.round(h*scaleY)}else{ih=imageData.height;iw=imageData.width;nh=imageData.naturalHeight;nw=imageData.naturalWidth;scaleX=iw/nw;scaleY=ih/nh;newWidth=Math.round(w*scaleX);newHeight=Math.round(h*scaleY)}}$minimumWidth=w;$minimumHeight=h;var r=gcd($minimumWidth,$minimumHeight);aspectRatio=$minimumWidth/r/($minimumHeight/r);if($cropper!=null){$cropper.cropper("setAspectRatio",aspectRatio);$cropper.cropper("setCropBoxData",{width:newWidth,height:newHeight,left:cbd.left,top:cbd.top})}}var CSS_TRANSITIONS=true;var DRAGDROP=false;if(Modernizr){if(!Modernizr.csstransitions){CSS_TRANSITIONS=false}if(window.FileReader&&Modernizr.draganddrop){DRAGDROP=true}}if(DRAGDROP){show(".show-modern")}else{show(".show-legacy");hide("#drop-zone-content")}if(!window.FileReader){hide(".show-modern");hide(".show-legacy");hide("#drop-zone");hide("#btn-group");error("Please upgrade your browser")}if(CROP_DEBUG){if(typeof window.FileReader==="undefined"){state.innerHTML="File API & FileReader unavailable"}else{state.innerHTML="File API & FileReader available"}}if($(".img-container img").length){hide("#drop-zone");show(".spinner");var src=$(".img-container img").data("img");var img=new Image;img.id="img-crop";img.onload=function(){if(created){destroy()}$(".img-container").empty();$(".img-container").append(img);if(!created){created=true}initCrop()};img.src=src}$(".img-container").on("dblclick",".cropper-crop-box",function(e){cropPreview()});$("#file").on("change",function(e){var file=e.target.files[0];initFile(file);$("#file").replaceWith($("#file").clone(true))});$("#toolbar").on("click","button",function(e){e.preventDefault();if(!$(this).attr("disable")){var action=$(this).data("action");var active=$(this).data("active");$("#toolbar button").removeClass("active");switch(action){case"toolbar-move":setDragMode("move");break;case"toolbar-crop":setDragMode("crop");break;case"toolbar-rotate-left":rotate(-1);break;case"toolbar-rotate-right":rotate(1);break;case"toolbar-reset":reset();break;case"toolbar-preview":cropPreview();break;case"toolbar-close-preview":undoPreview();break;case"toolbar-save":show(".cropper-crop-box");uploadCropped();break;case"toolbar-load":restart();break;case"toolbar-zoom-in":zoom(1);break;case"toolbar-zoom-out":zoom(-1);break;case"toolbar-help":showHelp();break;case"toolbar-help-close":showHelp();break}if(active){setActiveToolbar($(this))}setDragMode("move")}});function showHelp(){if($("#help").data("active")==true){$("#help").fadeOut(400);$("#help").data("active",false);hide($("#toolbar-help-close").parent());show($("#toolbar-help").parent());$("#toolbar-help-close").remove("active");$("#toolbar button").removeAttr("disabled")}else{$("#help").fadeIn(400);$("#help").data("active",true);hide($("#toolbar-help").parent());show($("#toolbar-help-close").parent());$("#toolbar-help-close").addClass("active");$("#toolbar button").not("#toolbar-help-close").attr("disabled",true)}}function setActiveToolbar(ele){$(ele).addClass("active")}function setDragMode(mode){$cropper.cropper("setDragMode",mode)}function cropReplace(src){if($cropper!=null){show(".spinner");$(".img-container").removeClass("active");hide("#toolbar");hide(".preview-thumb");if(created){destroy()}var img=new Image;img.id="img-crop";img.onload=function(){$(".img-container").empty();$(".img-container").append(img);if(!created){created=true}initCrop()};img.src=src}}function zoom(dir){if($cropper!=null){var amt=dir==1?.1:-.1;$cropper.cropper("zoom",amt)}}function rotate(dir){if($cropper!=null){var degree=dir==1?90:-90;$cropper.cropper("rotate",degree)}}function reset(){$cropper.cropper("reset");$(".preview-crop").empty();hide(".preview-wrap");show(".cropper-crop-box")}function restart(){destroy();$(".preview-thumb").removeAttr("style");hide($("toolbar-load").parent());hide($("#toolbar-save").parent());hide($("toolbar-load").parent());hide(".preview-wrap");hide(".savvi-crop");hide("#toolbar");show("#drop-zone")}function destroy(){$cropper.cropper("destroy");$(".preview-thumb").empty();$(".preview-crop").empty();$(".img-container").empty();$("#toolbar button").removeAttr("disabled");$("#toolbar button").removeClass("active")}function undoPreview(){$(".preview-crop").empty();hide(".preview-wrap");show(".cropper-crop-box");show($("#toolbar-preview").parent());hide($("#toolbar-preview-close").parent());$(window).off("resize.savvicrop");$("#toolbar button").removeAttr("disabled")}function cropPreview(){preview();hide($("#toolbar-preview").parent());show($("#toolbar-preview-close").parent());$("#toolbar-preview-close").addClass("active");$("#toolbar button").not("#toolbar-preview-close, #toolbar-save").attr("disabled",true)}$dropzone.ondragover=function(){this.className="highlight";return false};$dropzone.ondragend=function(){this.className="";return false};$dropzone.ondrop=function(e){e.preventDefault();this.className="";var file=e.dataTransfer.files[0];initFile(file);return false};function initFile(file){preInitCrop();var reader=new FileReader;reader.onload=function(event){var img=new Image;img.id="img-crop";img.onload=function(){if(created){destroy()}$(".img-container").append(img);if(!created){created=true}initCrop();if(this.naturalWidth<$minimumWidth||this.naturalHeight<$minimumHeight){error("The image is too small ("+this.naturalWidth+"x"+this.naturalHeight+"). Minimum required dimensions are "+$minimumWidth.toString()+"x"+$minimumHeight.toString());img=null;restart()}};img.src=event.target.result};$filename=file.name.substr(0,file.name.indexOf("."));reader.readAsDataURL(file)}function preview(){var containerHeight=$(".savvi-crop").height();var containerWidth=$(".savvi-crop").width();var blob=$cropper.cropper("getCroppedCanvas").toDataURL("image/jpeg",.9);var img=new Image;img.id="img-pv";img.onload=function(){centerPreview();previewResize()};img.src=blob;$(".preview-crop").append(img);show(".preview-wrap");hide(".cropper-crop-box")}function previewResize(){$(window).on("resize.savvicrop",function(){centerPreview()})}function centerPreview(){var containerHeight=$(".savvi-crop").height();var containerWidth=$(".savvi-crop").width();var imgH=$(".preview-crop img").height();$(".preview-crop").css({top:containerHeight/2-imgH/2})}function preInitCrop(){hide("#drop-zone");show(".spinner");show(".savvi-crop")}function initCrop(){hide("#drop-zone");show(".savvi-crop");hide("#error");show($("#toolbar-save").parent());show($("toolbar-load").parent());$cropper=$("#img-crop").cropper({aspectRatio:aspectRatio,zoomable:true,minContainerWidth:300,minContainerHeight:300,minCanvasWidth:300,minCanvasHeight:300,scalable:false,movable:true,preview:".preview-thumb",build:function(e){undoPreview()},built:function(){var isLoaded=$(".cropper-canvas img").get(0).naturalWidth>0?true:false;if(isLoaded){cropperReady()}else{$(".cropper-canvas img").one("load",function(){cropperReady()})}setDragMode("move")},cropmove:function(e){setData()},cropend:function(e){setData()}})}function cropperReady(){hide(".spinner",400);$(".img-container").addClass("active");show(".preview-thumb",400);$cropper.cropper("setData",{width:$minimumWidth,height:$minimumHeight});show("#toolbar",400)}function setData(){if(aspectRatio!="auto"){var data=$cropper.cropper("getData",true);if(data.height<$minimumHeight){data.height=$minimumHeight}if(data.width<$minimumWidth){data.width=$minimumWidth}$cropper.cropper("setData",data)}}function uploadCropped(){hide("#error");var blob=$cropper.cropper("getCroppedCanvas").toDataURL("image/jpeg",.9);blob=blob.replace(/^data:image\/(png|jpg|jpeg);base64,/,"");var formData=new FormData;formData.append("croppedImage",blob);formData.append("filename",$filename);formData.append("filewidth",$minimumWidth);formData.append("fileheight",$minimumHeight);formData.append("_token",$("#_token").val());$("#image-cropped-filename").val("");blockUI("Uploading Image...");$.ajax({url:uploadScript,method:"POST",data:formData,processData:false,contentType:false,dataType:"json",success:function(data){if(data.valid==true){$("#image-cropped-filename").val(data.imageName);undoPreview();unblockUI();onCropSubmit()}else{var msg="There was a problem, please contact support";if(data.msg){msg=data.msg}error(msg);unblockUI()}},error:function(){console.log("Upload error");var msg="There was a problem, please contact support";error(msg);undoPreview();unblockUI()}})}function blockUI(message){$.blockUI({fadeOut:400,fadeIn:200,baseZ:99999,message:message,css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"5px","-moz-border-radius":"5px","border-radius":"5px",opacity:.5,color:"#fff"}})}function unblockUI(){$.unblockUI()}}$(document).ready(function(){setCropDimensions("200","200");$("body").on("onCropSubmit",function(){var imageName=$("#image-cropped-filename").val();blockUI("Saving Image...");$.post("http://alexandria.dev/profile/save-photo",{profileImageName:imageName,_token:"PjYU9jgdmamGf45w2TSoP5rzzNmt4LTPu6zYShxg"},function(data){if(data.valid==true){window.location="http://alexandria.dev/profile/photo"}else{var msg="There was a problem saving your profile photo, please try again.";if(data.msg){msg=data.msg}error(msg);unblockUI()}},"json")})});
