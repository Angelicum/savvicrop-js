var SavviCrop=function(options,element,callback){var callback=callback||function(){};var defaults={required:false,minCropSize:[200,200],id:"real-file",name:false,cropRatio:"fixed",imageData:false,modal:false,editor:true,imageQuality:"1",buttons:{rotateLeft:true,rotateRight:true,zoomIn:true,zoomOut:true,preview:true,load:true},maxOutputSize:[1200,1200],labels:{drag:"Drag &amp; Drop Your Image Here",drop:"Drop Image Here"}};this.options=$.extend(true,defaults,options);if(this.options.name==false){this.options.name=this.options.id}this.options.id=this.options.id.replace(/[^a-z0-9]/gi,"");if(this.checkIncludes()==false)return;this.UPLOAD_URL="/image-crop";this.MIN_WIDTH=this.options.minCropSize[0];this.MIN_HEIGHT=this.options.minCropSize[1];this.CROP_DEBUG=false;this.CSS_TRANSITIONS=true;this.DRAGDROP=false;this.ASPECT_RATIO="auto";if(this.options.cropRatio=="fixed"){this.ASPECT_RATIO=this.MIN_WIDTH/this.MIN_HEIGHT}this.createElements(element);this.$el=$('[data-id="sc-binder-'+this.options.id+'"]');this.buildToolbar(this.$el);this.$dropzone=this.$el.find(".sc-drop-wrapper");this.$cropper=false;this.created=false;this.filename="tmp";this.$cropperCropBox=this.$el.find(".cropper-crop-box");this.$spinner=this.$el.find(".sc-spinner");this.$fileUpload=this.$el.find(".sc-file-upload");this.$uploadPreview=this.$el.find(".sc-upload-thumb");this.$uploadClear=this.$el.find(".sc-upload-clear");this.$fileData=this.$el.find(".sc-file-blob");this.$imgarea=this.$el.find(".sc-img-container");this.$toolbar=this.$el.find(".sc-toolbar");this.$previewWrap=this.$el.find(".sc-preview-wrap");this.$previewThumb=this.$el.find(".sc-preview-thumb");this.$previewCrop=this.$el.find(".sc-preview-crop");this.$workarea=this.$el.find(".sc-workarea");this.$fileType=null;this.$modal;this.init()};SavviCrop.prototype.checkIncludes=function(){var isOkay=true;if(!window.jQuery){console.log("[-] Error: jQuery is not installed.");isOkay=false}if(!typeof bootstrap.Modal=="function"){console.log("[-] Error: bootstrap is not installed.");isOkay=false}return isOkay};SavviCrop.onCropSubmit=function(){$("body").trigger("onCropSubmit")};SavviCrop.prototype.show=function(ele,fade){if(typeof fade==="undefined"||fade===null){fade=0}$(ele).removeClass("cloak");$(ele).stop(false,true).show(fade)};SavviCrop.prototype.hide=function(ele,fade){if(typeof fade==="undefined"||fade===null){fade=0}$(ele).stop(false,true).hide(fade)};SavviCrop.prototype.error=function(msg){var self=this;$(".error-msg").text(msg);self.show("#error")};SavviCrop.prototype.gcd=function(a,b){return b==0?a:gcd(b,a%b)};SavviCrop.prototype.setCropDimensions=function(w,h){if($cropper!=null){var e=$cropper.cropper("getData");var imageData=$cropper.cropper("getImageData");var cbd=$cropper.cropper("getCropBoxData");var rotate=Math.abs(imageData.rotate)===90;var ih,iw,nh,nw,scaleX,scaleY,newHeight,newWidth;if(rotate){ih=imageData.width;iw=imageData.height;nh=imageData.naturalWidth;nw=imageData.naturalHeight;scaleX=ih/nh;scaleY=iw/nw;newWidth=Math.round(w*scaleX);newHeight=Math.round(h*scaleY)}else{ih=imageData.height;iw=imageData.width;nh=imageData.naturalHeight;nw=imageData.naturalWidth;scaleX=iw/nw;scaleY=ih/nh;newWidth=Math.round(w*scaleX);newHeight=Math.round(h*scaleY)}}MIN_WIDTH=w;MIN_HEIGHT=h;var r=gcd(MIN_WIDTH,MIN_HEIGHT);aspectRatio=MIN_WIDTH/r/(MIN_HEIGHT/r);if($cropper!=null){$cropper.cropper("setAspectRatio",aspectRatio);$cropper.cropper("setCropBoxData",{width:newWidth,height:newHeight,left:cbd.left,top:cbd.top})}};SavviCrop.prototype.init=function(){var self=this;if(typeof $.fn.tooltip!=="undefined"){$(self.$uploadClear).tooltip()}self.$uploadClear.on("click",function(){self.restart();self.updateStatus("default",self.options.labels.drag)});self.$toolbar.on("click","button",function(e){e.preventDefault();if(!$(this).attr("disable")){var action=$(this).data("action");var active=$(this).data("active");self.$toolbar.find("button").removeClass("active");switch(action){case"toolbar-move":self.setDragMode("move");break;case"toolbar-crop":self.setDragMode("crop");break;case"toolbar-rotate-left":self.rotate(-1);break;case"toolbar-rotate-right":self.rotate(1);break;case"toolbar-reset":self.reset();break;case"toolbar-preview":self.cropPreview();break;case"toolbar-preview-close":self.undoPreview();break;case"toolbar-save":self.show(self.$cropperCropBox);self.saveCropped();if(self.options.modal){self.$modal.hide()}break;case"toolbar-load":if(self.options.modal){self.$modal.hide()}self.restart();break;case"toolbar-zoom-in":self.zoom(1);break;case"toolbar-zoom-out":self.zoom(-1);break}if(active){self.setActiveToolbar($(this))}self.setDragMode("move")}});var input=self.$fileUpload;var theFile=null;self.updateStatus("default",self.options.labels.drag);input.on({dragenter:function(e){self.updateStatus("success",self.options.labels.drop)},dragleave:function(e){self.updateStatus("default",self.options.labels.drag)},dragover:function(e){e.preventDefault()},drop:function(e){theFile=e.originalEvent.dataTransfer.files[0]||e.target.files[0];self.initFile(theFile)},change:function(e){theFile=this.files[0];if(theFile){self.initFile(theFile)}}});if(self.options.imageData){self.$fileData.val(self.options.imageData);self.$uploadPreview.css("background-image",'url("'+self.options.imageData+'")');self.show(self.$uploadClear);self.updateStatus("success","Image Attached")}if(self.options.modal){$("#sc-modal-"+self.options.id).find("#sc-modal-sub-"+self.options.id).click(function(){self.show(self.$cropperCropBox);self.saveCropped();if(self.options.modal){self.$modal.hide()}})}};SavviCrop.prototype.setActiveToolbar=function(ele){$(ele).addClass("active")};SavviCrop.prototype.setDragMode=function(mode){var self=this;self.$cropper.cropper("setDragMode",mode)};SavviCrop.prototype.cropReplace=function(src){var self=this;if(self.$cropper!=null){self.show(self.$spinner);self.$imgarea.removeClass("active");self.hide(self.$toolbar);self.hide(self.$previewThumb);if(self.created){self.destroy()}var img=new Image;img.id="img-crop-"+self.options.id;img.onload=function(){self.$imgarea.empty();self.$imgarea.append(img);if(!self.created){self.created=true}self.initCrop()};img.src=src}};SavviCrop.prototype.zoom=function(dir){var self=this;if(self.$cropper!=null){var amt=dir==1?.1:-.1;self.$cropper.cropper("zoom",amt)}};SavviCrop.prototype.rotate=function(dir){var self=this;if(self.$cropper!=null){var degree=dir==1?90:-90;self.$cropper.cropper("rotate",degree)}};SavviCrop.prototype.reset=function(){var self=this;if(self.$cropper.cropper){self.$cropper.cropper("reset")}self.$previewCrop.empty();self.hide(self.$previewWrap);self.show(self.$cropperCropBox);self.updateStatus("default","Drag Image Here.")};SavviCrop.prototype.restart=function(){var self=this;self.destroy();self.$previewThumb.removeAttr("style");self.hide(self.$uploadClear);self.hide(self.$el.find('[data-action="toolbar-load"]').parent());self.hide(self.$el.find('[data-action="toolbar-save"]').parent());self.hide(self.$el.find('[data-action="toolbar-load"]').parent());self.hide(self.$previewWrap);self.hide(self.$workarea);self.hide(self.$toolbar);self.$spinner.fadeOut(100);self.show(self.$dropzone);self.resetUpload()};SavviCrop.prototype.resetUpload=function(){var self=this;self.$fileUpload.val("");self.$uploadPreview.css("background-image","none");self.$fileData.val("")};SavviCrop.prototype.destroy=function(){var self=this;if(self.$cropper.cropper){self.$cropper.cropper("destroy")}$(self.$previewThumb).empty();$(self.$previewCrop).empty();self.$imgarea.empty();self.$toolbar.find("button").removeAttr("disabled");self.$toolbar.find("button").removeClass("active")};SavviCrop.prototype.undoPreview=function(){var self=this;$(self.$previewCrop).empty();self.hide(self.$previewWrap);self.show(self.$cropperCropBox);self.show(self.$el.find('[data-action="toolbar-preview"]').parent());self.hide(self.$el.find('[data-action="toolbar-preview-close"]').parent());$(window).off("resize.savvicrop");self.$toolbar.find("button").removeAttr("disabled")};SavviCrop.prototype.cropPreview=function(){var self=this;self.preview();self.hide(self.$el.find('[data-action="toolbar-preview"]').parent());self.show(self.$el.find('[data-action="toolbar-preview-close"]').parent());self.$el.find('[data-action="toolbar-preview-close"]').addClass("active");self.$toolbar.find("button").not('[data-action="toolbar-preview-close"], [data-action="toolbar-save"]').attr("disabled",true)};SavviCrop.prototype.downsampleImage=function(img){console.log(img.height,img.width);var self=this;var canvas=document.createElement("canvas");var ctx=canvas.getContext("2d");var cw=canvas.width;var ch=canvas.height;var iw=img.width;var ih=img.height;var maxH=self.options.maxOutputSize[0];var maxW=self.options.maxOutputSize[1];var scale=Math.min(maxW/iw,maxH/ih);var iwScaled=iw*scale;var ihScaled=ih*scale;if(iw<=maxW||ih<=maxH){canvas.width=iw;canvas.height=ih;ctx.drawImage(img,0,0,iw,ih)}else{canvas.width=iwScaled;canvas.height=ihScaled;ctx.drawImage(img,0,0,iwScaled,ihScaled)}return canvas.toDataURL(self.$fileType,self.options.imageQuality)};SavviCrop.prototype.initFile=function(file){var self=this;var reader=new FileReader;self.$fileType=file.type;self.preInitCrop();if(file.type!=="image/png"&&file.type!=="image/jpg"&&file.type!=="image/jpeg"&&file.type!=="image/gif"){self.updateStatus("error","Image is the wrong filetype.");self.restart();return false}reader.onload=function(event){var img=new Image;img.id="img-crop-"+self.options.id;img.onload=function(){if(self.created){self.destroy()}self.$imgarea.append(img);if(!self.created){self.created=true}if(this.naturalWidth<self.MIN_WIDTH||this.naturalHeight<self.MIN_HEIGHT){self.updateStatus("error","Image is too small: ("+this.naturalWidth+"x"+this.naturalHeight+"). Required minimum dimensions: ("+self.MIN_WIDTH.toString()+"x"+self.MIN_HEIGHT.toString()+").");img=null;self.restart()}else{self.initCrop();self.$fileUpload.val("")}};img.src=event.target.result};if(file){self.filename=file.name.substr(0,file.name.indexOf("."))}else{self.filename="untitled"}reader.readAsDataURL(file)};SavviCrop.prototype.preview=function(){var self=this;var blob=self.$cropper.cropper("getCroppedCanvas").toDataURL(self.$fileType,self.options.imageQuality);var img=new Image;img.id="img-pv";img.onload=function(){self.centerPreview();self.previewResize()};img.src=blob;self.$previewCrop.append(img);self.show(self.$previewWrap);self.hide(self.$cropperCropBox)};SavviCrop.prototype.previewResize=function(){var self=this;$(window).on("resize.savvicrop",function(){self.centerPreview()})};SavviCrop.prototype.centerPreview=function(){var self=this;var containerHeight=$(self.$workarea).height();var containerWidth=$(self.$workarea).width();var imgH=self.$previewCrop.find("img").height();self.$previewCrop.css({top:containerHeight/2-imgH/2})};SavviCrop.prototype.preInitCrop=function(){var self=this;self.show(self.$spinner)};SavviCrop.prototype.initCrop=function(){var self=this;if(!self.options.editor){var img=$("#img-crop-"+self.options.id).get(0);var blob=self.downsampleImage(img);self.$fileData.val(blob);self.updateStatus("success","Image Attached");self.$fileUpload.val("");self.$uploadPreview.css("background-image",'url("'+blob+'")');self.show(self.$uploadClear);self.hide(self.$spinner);return}if(self.options.modal){self.$modal.show();$("#sc-modal-"+self.options.id).off("shown.bs.modal");$("#sc-modal-"+self.options.id).on("shown.bs.modal",function(){console.log("Trigger");$(window).trigger("resize")});$("#sc-modal-"+self.options.id).off("hidden.bs.modal");$("#sc-modal-"+self.options.id).on("hidden.bs.modal",function(){self.show(self.$dropzone)})}self.updateStatus("default","Drag &amp; Drop Your Image Here.");self.hide(self.$dropzone);self.show(self.$workarea);self.hide("#error");self.show(self.$el.find('[data-action="toolbar-save"]').parent());self.show(self.$el.find('[data-action="toolbar-load"]').parent());self.$cropper=$("#img-crop-"+self.options.id).cropper({aspectRatio:self.ASPECT_RATIO,minCropBoxWidth:50,minCropBoxHeight:50,zoomable:true,autoCropArea:1,scalable:false,movable:true,zoomOnWheel:false,preview:self.$previewThumb,restore:false,build:function(e){self.undoPreview()},built:function(){var img=$("#img-crop-"+self.options.id).get(0);var isLoaded=img.naturalWidth>0?true:false;if(isLoaded){self.cropperReady(img)}else{$("#img-crop-"+self.options.id).one("load",function(){img=$("#img-crop-"+self.options.id).get(0);self.cropperReady(img)})}self.setDragMode("move")},cropstart:function(e){},cropmove:function(e){},cropend:function(e){},zoom:function(e){}})};SavviCrop.prototype.cropperReady=function(img){var self=this;self.hide(self.$spinner);self.$imgarea.addClass("active");self.show(self.$previewThumb);self.show(self.$toolbar)};SavviCrop.prototype.updateStatus=function(type,message){var self=this;var messageArea=self.$el.find(".sc-status");switch(type){case"default":self.$dropzone.removeClass("error");self.$dropzone.removeClass("highlight");break;case"success":self.$dropzone.removeClass("error");self.$dropzone.addClass("highlight");break;case"error":self.$dropzone.addClass("error");self.$dropzone.removeClass("highlight")}messageArea.html(message)};SavviCrop.prototype.saveCropped=function(){var self=this;var canvas=self.$cropper.cropper("getCroppedCanvas");var canvasArgs={width:canvas.width,height:canvas.height};if(canvas.height<self.MIN_HEIGHT){canvasArgs.height=self.MIN_HEIGHT}if(canvas.width<self.MIN_WIDTH){canvasArgs.width=self.MIN_WIDTH}var canvas=self.$cropper.cropper("getCroppedCanvas",canvasArgs);var blob=self.downsampleImage(canvas);var imgArea=self.$el.find(".sc-image-area");self.$fileData.val(blob);self.destroy();self.$previewThumb.removeAttr("style");self.hide(self.$el.find('[data-action="toolbar-load"]').parent());self.hide(self.$el.find('[data-action="toolbar-save"]').parent());self.hide(self.$el.find('[data-action="toolbar-load"]').parent());self.hide(self.$previewWrap);self.hide(self.$workarea);self.hide(self.$toolbar);self.show(self.$dropzone);self.updateStatus("success","Image Attached");self.$fileUpload.val("");self.$uploadPreview.css("background-image",'url("'+blob+'")');self.show(self.$uploadClear)};SavviCrop.prototype.createElements=function(el){var self=this;var c="";var m="";var strRequired="";if(self.options.required){strRequired='required="required"'}c+='<div data-id="sc-binder-'+self.options.id+'">';c+='<div class="sc-drop-wrapper">';c+='<div class="sc-upload-thumb"><div class="sc-upload-clear" title="Clear Image">&times;</div></div>';c+='<div class="sc-upload-gap"></div>';c+='<div class="sc-dropzone">';c+='<div class="cloak sc-spinner"><i class="fa fa-spin fa-refresh"></i></div>';c+='<div class="sc-dropzone-msg">';c+='<div class="head1"><span class="sc-image-area"></span><span class="sc-status"></span></div>';c+='<div class="head2"><i class="fa fa-picture-o"></i> We recommend JPG, PNG or GIF</div>';c+="</div>";c+='<div class="head3">- or -</div>';c+='<button class="btn"><i class="fa fa-upload"></i> Browse For Image</button>';c+='<input type="file" class="sc-file-upload" name="ghost-file" title="Click to upload an image.">';c+='<textarea style="width:1px; display:none;" class="sc-file-blob" '+strRequired+' id="'+self.options.id+'" name="'+self.options.name+'"></textarea>';c+="</div>";c+="</div>";c+="</div>";$(el).html(c);m+='<div class="sc-toolbar clearfix">';m+="</div>";m+='<div class="sc-workarea">';m+='<div class="sc-preview-thumb"></div>';m+='<div class="sc-preview-wrap cloak">';m+='<div class="sc-preview-crop"></div>';m+="</div>";m+='<div class="sc-img-container">';m+="</div>";m+="</div>";if(self.options.modal){var n="";n+='<div id="sc-modal-'+self.options.id+'" data-id="sc-binder-'+self.options.id+'" class="modal fade '+$(el).attr("class")+'" role="dialog" data-backdrop="static" data-keyboard="false">';n+='<div class="modal-dialog modal-xl">';n+='<div class="modal-content">';n+='<div class="modal-header">';n+='<h3 class="modal-title">Image Editor</h3>';n+='<button type="button" class="btn-close" data-bs-dismiss="modal"></button>';n+="</div>";n+='<div class="modal-body">'+m;n+="</div>";n+='<div class="modal-footer">';n+='<button class="btn btn-success" id="sc-modal-sub-'+self.options.id+'"><i class="fa fa-check-circle"></i> Save</button>';n+="</div>";n+="</div>";n+="</div>";n+="</div>";$("body").append(n);console.log("Element",document.getElementById("sc-modal-"+self.options.id));this.$modal=new bootstrap.Modal(document.getElementById("sc-modal-"+self.options.id));console.log("Modal",this.$modal);console.log("Loaded",self);this.$modal.show()}else{$(el).append('<div data-id="sc-binder-'+self.options.id+'">'+m+"</div>")}};SavviCrop.prototype.buildToolbar=function(el){var $toolbar=$(el).find(".sc-toolbar");var self=this;var opts=self.options.buttons;var c="";c+='<ul class="pull-left">';if(opts.rotateLeft){c+='<li><button data-action="toolbar-rotate-left" data-active="false" title="Rotate Left"><i class="fa fa-fw fa-rotate-left"></i></button></li>'}if(opts.rotateRight){c+='<li><button data-action="toolbar-rotate-right" data-active="false" title="Rotate Right"><i class="fa fa-fw fa-rotate-right"></i></button></li>'}if(opts.zoomIn){c+='<li><button data-action="toolbar-zoom-in" data-active="false" title="Zoom In"><i class="fa fa-fw fa-search-plus"></i></button></li>'}if(opts.zoomOut){c+='<li><button data-action="toolbar-zoom-out" data-active="false" title="Zoom Out"><i class="fa fa-fw fa-search-minus"></i></button></li>'}if(opts.preview){c+='<li><button data-action="toolbar-preview" data-active="false" title="Preview"><i class="fa fa-fw fa-eye"></i></button></li>';c+='<li class="cloak"><button data-action="toolbar-preview-close" data-active="false" title="Close Preview"><i class="fa fa-fw fa-eye-slash"></i></button></li>'}if(opts.reset){c+='<li><button data-action="toolbar-reset" data-active="false" title="Reset"><i class="fa fa-fw fa-ban"></i></button></li>'}c+="</ul>";c+='<ul class="pull-right">';c+='<li class="pull-right" ><button data-action="toolbar-save" data-active="false" title="Save Cropped File"><i class="fa fa-fw fa-check-circle txt-success"></i></button></li>';if(opts.load){c+='<li class="pull-right"><button data-action="toolbar-load" data-active="false" title="Edit Another File"><i class="fa fa-ban"></i></button></li>'}c+="</ul>";$toolbar.html(c);if(typeof $.fn.tooltip!=="undefined"){$toolbar.find("button").each(function(){$(this).attr("data-placement","bottom");$(this).tooltip();$(this).on("click tap",function(){$(this).tooltip("hide")})})}};(function($){$.fn.savviCrop=function(options,callback){if(typeof options=="string"){var savviCrop=$(this).data("savvicrop");switch(options){case"reset":savviCrop.restart();savviCrop.reset();break}}else{this.each(function(){var savviCrop=new SavviCrop(options,this,callback);$(this).data("savvicrop",savviCrop);return savviCrop})}}})(jQuery);
