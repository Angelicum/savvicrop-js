var SavviCrop=function(options,element,callback){var callback=callback||function(){};var defaults={required:false};this.options=$.extend(true,defaults,options);this.createElements(element);this.$el=$(element);this.$dropzone=$(element).find(".sc-dropzone");this.$cropper=false;this.created=false;this.filename="tmp";this.$status=$(element).find(".sc-status");this.$fileUpload=$(element).find(".sc-file-upload");this.$fileData=$(element).find(".sc-file-blob");this.$imgarea=$(element).find(".sc-img-container");this.$help=$(element).find(".sc-help");this.$toolbar=$(element).find(".sc-toolbar");this.$previewWrap=$(element).find(".sc-preview-wrap");this.$previewThumb=$(element).find(".sc-preview-thumb");this.$previewCrop=$(element).find(".sc-preview-crop");this.$workarea=$(element).find(".sc-workarea");this.UPLOAD_URL="/image-crop";this.MIN_WIDTH=320;this.MIN_HEIGHT=110;this.CROP_DEBUG=false;this.CSS_TRANSITIONS=true;this.DRAGDROP=false;this.ASPECT_RATIO="auto";this.init()};SavviCrop.onCropSubmit=function(){$("body").trigger("onCropSubmit")};SavviCrop.prototype.isEventSupported=function(eventName,element){var TAGNAMES={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};element=element||document.createElement(TAGNAMES[eventName]||"div");eventName="on"+eventName;var isSupported=eventName in element;if(!isSupported){if(!element.setAttribute){element=document.createElement("div")}if(element.setAttribute&&element.removeAttribute){element.setAttribute(eventName,"");isSupported=typeof element[eventName]=="function";if(typeof element[eventName]!="undefined"){element[eventName]=undefined}element.removeAttribute(eventName)}}element=null;return isSupported};SavviCrop.prototype.show=function(ele,fade){if(typeof fade==="undefined"||fade===null){fade=0}$(ele).removeClass("cloak");$(ele).show(fade)};SavviCrop.prototype.hide=function(ele,fade){if(typeof fade==="undefined"||fade===null){fade=0}$(ele).hide(fade)};SavviCrop.prototype.error=function(msg){var self=this;$(".error-msg").text(msg);self.show("#error")};SavviCrop.prototype.gcd=function(a,b){return b==0?a:gcd(b,a%b)};SavviCrop.prototype.setCropDimensions=function(w,h){if($cropper!=null){var e=$cropper.cropper("getData");var imageData=$cropper.cropper("getImageData");var cbd=$cropper.cropper("getCropBoxData");var rotate=Math.abs(imageData.rotate)===90;var ih,iw,nh,nw,scaleX,scaleY,newHeight,newWidth;if(rotate){ih=imageData.width;iw=imageData.height;nh=imageData.naturalWidth;nw=imageData.naturalHeight;scaleX=ih/nh;scaleY=iw/nw;newWidth=Math.round(w*scaleX);newHeight=Math.round(h*scaleY)}else{ih=imageData.height;iw=imageData.width;nh=imageData.naturalHeight;nw=imageData.naturalWidth;scaleX=iw/nw;scaleY=ih/nh;newWidth=Math.round(w*scaleX);newHeight=Math.round(h*scaleY)}}MIN_WIDTH=w;MIN_HEIGHT=h;var r=gcd(MIN_WIDTH,MIN_HEIGHT);aspectRatio=MIN_WIDTH/r/(MIN_HEIGHT/r);if($cropper!=null){$cropper.cropper("setAspectRatio",aspectRatio);$cropper.cropper("setCropBoxData",{width:newWidth,height:newHeight,left:cbd.left,top:cbd.top})}};SavviCrop.prototype.init=function(){var self=this;self.$toolbar.on("click","button",function(e){e.preventDefault();if(!$(this).attr("disable")){var action=$(this).data("action");var active=$(this).data("active");self.$toolbar.find("button").removeClass("active");switch(action){case"toolbar-move":self.setDragMode("move");break;case"toolbar-crop":self.setDragMode("crop");break;case"toolbar-rotate-left":self.rotate(-1);break;case"toolbar-rotate-right":self.rotate(1);break;case"toolbar-reset":self.reset();break;case"toolbar-preview":self.cropPreview();break;case"toolbar-close-preview":self.undoPreview();break;case"toolbar-save":self.show(".cropper-crop-box");self.saveCropped();break;case"toolbar-load":self.restart();break;case"toolbar-zoom-in":self.zoom(1);break;case"toolbar-zoom-out":self.zoom(-1);break;case"toolbar-help":self.showHelp();break;case"toolbar-help-close":self.showHelp();break}if(active){self.setActiveToolbar($(this))}self.setDragMode("move")}});var input=self.$fileUpload;input.on({dragenter:function(e){self.$dropzone.addClass("highlight")},dragleave:function(e){self.$dropzone.removeClass("highlight")}});input.on("change",function(e){var file=this.files[0]||e.target.files[0];console.log(input.val());self.initFile(file)})};SavviCrop.prototype.showHelp=function(){var self=this;if(self.$help.data("active")==true){self.$help.fadeOut(400);self.$help.data("active",false);self.hide(self.$el.find('[data-action="toolbar-help-close"]').parent());self.show(self.$el.find('[data-action="toolbar-help"]').parent());self.$el.find('[data-action="toolbar-help-close"]').remove("active");self.$toolbar.find("button").removeAttr("disabled")}else{self.$help.fadeIn(400);self.$help.data("active",true);self.hide(self.$el.find('[data-action="toolbar-help"]').parent());self.show(self.$el.find('[data-action="toolbar-help-close"]').parent());self.$el.find('[data-action="toolbar-help-close"]').addClass("active");self.$toolbar.find("button").not('[data-action="toolbar-help-close"]').attr("disabled",true)}};SavviCrop.prototype.setActiveToolbar=function(ele){$(ele).addClass("active")};SavviCrop.prototype.setDragMode=function(mode){var self=this;self.$cropper.cropper("setDragMode",mode)};SavviCrop.prototype.cropReplace=function(src){var self=this;if(self.$cropper!=null){self.show(".spinner");self.$imgarea.removeClass("active");self.hide(self.$toolbar);self.hide(self.$previewThumb);if(self.created){self.destroy()}var img=new Image;img.id="img-crop";img.onload=function(){self.$imgarea.empty();self.$imgarea.append(img);if(!self.created){self.created=true}self.initCrop()};img.src=src}};SavviCrop.prototype.zoom=function(dir){var self=this;if(self.$cropper!=null){var amt=dir==1?.1:-.1;self.$cropper.cropper("zoom",amt)}};SavviCrop.prototype.rotate=function(dir){var self=this;if(self.$cropper!=null){var degree=dir==1?90:-90;self.$cropper.cropper("rotate",degree)}};SavviCrop.prototype.reset=function(){var self=this;self.$cropper.cropper("reset");self.$previewCrop.empty();self.hide(self.$previewWrap);self.show(".cropper-crop-box")};SavviCrop.prototype.restart=function(){var self=this;self.destroy();self.$previewThumb.removeAttr("style");self.hide(self.$el.find('[data-action="toolbar-load"]').parent());self.hide(self.$el.find('[data-action="toolbar-save"]').parent());self.hide(self.$el.find('[data-action="toolbar-load"]').parent());self.hide(self.$previewWrap);self.hide(self.$workarea);self.hide(self.$toolbar);self.show(self.$dropzone);self.$status.html("Drag Image Here.");self.$fileUpload.val("");self.$dropzone.removeClass("highlight")};SavviCrop.prototype.destroy=function(){var self=this;self.$cropper.cropper("destroy");$(self.$previewThumb).empty();$(self.$previewCrop).empty();self.$imgarea.empty();self.$toolbar.find("button").removeAttr("disabled");self.$toolbar.find("button").removeClass("active")};SavviCrop.prototype.undoPreview=function(){var self=this;$(self.$previewCrop).empty();self.hide(self.$previewWrap);self.show(".cropper-crop-box");self.show(self.$el.find('[data-action="toolbar-preview"]').parent());self.hide(self.$el.find('[data-action="toolbar-preview-close"]').parent());$(window).off("resize.savvicrop");self.$toolbar.find("button").removeAttr("disabled")};SavviCrop.prototype.cropPreview=function(){var self=this;self.preview();self.hide(self.$el.find('[data-action="toolbar-preview"]').parent());self.show(self.$el.find('[data-action="toolbar-preview-close"]').parent());self.$el.find('[data-action="toolbar-preview-close"]').addClass("active");self.$toolbar.find("button").not('[data-action="toolbar-preview-close"], [data-action="toolbar-save"]').attr("disabled",true)};SavviCrop.prototype.initFile=function(file){var self=this;var reader=new FileReader;self.preInitCrop();reader.onload=function(event){var img=new Image;img.id="img-crop";img.onload=function(){if(self.created){self.destroy()}self.$imgarea.append(img);if(!self.created){self.created=true}self.initCrop();self.$fileUpload.val("");if(this.naturalWidth<self.MIN_WIDTH||this.naturalHeight<self.MIN_HEIGHT){self.error("The image is too small ("+this.naturalWidth+"x"+this.naturalHeight+"). Minimum required dimensions are "+self.MIN_WIDTH.toString()+"x"+self.MIN_HEIGHT.toString());img=null;self.restart()}};img.src=event.target.result};self.filename=file.name.substr(0,file.name.indexOf("."));reader.readAsDataURL(file)};SavviCrop.prototype.preview=function(){var self=this;var containerHeight=$(self.$workarea).height();var containerWidth=$(self.$workarea).width();var blob=self.$cropper.cropper("getCroppedCanvas").toDataURL("image/jpeg",.9);var img=new Image;img.id="img-pv";img.onload=function(){self.centerPreview();self.previewResize()};img.src=blob;self.$previewCrop.append(img);self.show(self.$previewWrap);self.hide(".cropper-crop-box")};SavviCrop.prototype.previewResize=function(){var self=this;$(window).on("resize.savvicrop",function(){self.centerPreview()})};SavviCrop.prototype.centerPreview=function(){var containerHeight=$(self.$workarea).height();var containerWidth=$(self.$workarea).width();var imgH=self.$previewCrop.find("img").height();self.$previewCrop.css({top:containerHeight/2-imgH/2})};SavviCrop.prototype.preInitCrop=function(){var self=this;self.hide(self.$dropzone);self.show(".spinner");self.show(self.$workarea)};SavviCrop.prototype.initCrop=function(){var self=this;self.hide(self.$dropzone);self.show(self.$workarea);self.hide("#error");self.show(self.$el.find('[data-action="toolbar-save"]').parent());self.show(self.$el.find('[data-action="toolbar-load"]').parent());self.$cropper=$("#img-crop").cropper({aspectRatio:self.ASPECT_RATIO,zoomable:true,minContainerWidth:300,minContainerHeight:300,minCanvasWidth:300,minCanvasHeight:300,scalable:false,movable:true,preview:self.$previewThumb,build:function(e){self.undoPreview()},built:function(){var isLoaded=$(".cropper-canvas img").get(0).naturalWidth>0?true:false;if(isLoaded){self.cropperReady()}else{$(".cropper-canvas img").one("load",function(){self.cropperReady()})}self.setDragMode("move")},cropmove:function(e){self.setData()},cropend:function(e){self.setData()}})};SavviCrop.prototype.cropperReady=function(){var self=this;self.hide(".spinner",400);self.$imgarea.addClass("active");self.show(self.$previewThumb,400);self.$cropper.cropper("setData",{width:self.MIN_WIDTH,height:self.MIN_HEIGHT});self.show(self.$toolbar,400)};SavviCrop.prototype.setData=function(){var self=this;if(self.ASPECT_RATIO!="auto"){var data=self.$cropper.cropper("getData",true);if(data.height<self.MIN_HEIGHT){data.height=self.MIN_HEIGHT}if(data.width<self.MIN_WIDTH){data.width=self.MIN_WIDTH}self.$cropper.cropper("setData",data)}};SavviCrop.prototype.saveCropped=function(){var self=this;var blob=self.$cropper.cropper("getCroppedCanvas").toDataURL("image/jpeg",.9);this.$fileData.val(blob);self.destroy();self.$previewThumb.removeAttr("style");self.hide(self.$el.find('[data-action="toolbar-load"]').parent());self.hide(self.$el.find('[data-action="toolbar-save"]').parent());self.hide(self.$el.find('[data-action="toolbar-load"]').parent());self.hide(self.$previewWrap);self.hide(self.$workarea);self.hide(self.$toolbar);self.show(self.$dropzone);self.$status.html("Image Attached");self.$fileUpload.val("")};SavviCrop.prototype.blockUI=function(message){$.blockUI({fadeOut:400,fadeIn:200,baseZ:99999,message:message,css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"5px","-moz-border-radius":"5px","border-radius":"5px",opacity:.5,color:"#fff"}})};SavviCrop.prototype.unblockUI=function(){$.unblockUI()};SavviCrop.prototype.createElements=function(el){var self=this;var c="";c+='<div class="spinner cloak"></div>';c+='<div class="sc-toolbar clearfix">';c+='<ul class="pull-left">';c+='<li><button data-action="toolbar-rotate-left" data-active="false" title="Rotate Left"><i class="fa fa-fw fa-rotate-left"></i></button></li>';c+='<li><button data-action="toolbar-rotate-right" data-active="false" title="Rotate Right"><i class="fa fa-fw fa-rotate-right"></i></button></li>';c+='<li><button data-action="toolbar-zoom-in" data-active="false" title="Zoom In"><i class="fa fa-fw fa-search-plus"></i></button></li>';c+='<li><button data-action="toolbar-zoom-out" data-active="false" title="Zoom Out"><i class="fa fa-fw fa-search-minus"></i></button></li>';c+='<li><button data-action="toolbar-preview" data-active="false" title="Preview"><i class="fa fa-fw fa-eye"></i></button></li>';c+='<li class="cloak"><button data-action="toolbar-close-preview" data-active="false" title="Close Preview"><i class="fa fa-fw fa-eye-slash"></i></button></li>';c+='<li><button data-action="toolbar-reset" data-active="false" title="Reset"><i class="fa fa-fw fa-ban"></i></button></li>';c+="</ul>";c+='<ul class="pull-right">';c+='<li class="pull-right" ><button data-action="toolbar-save" data-active="false" title="Save Cropped File"><i class="fa fa-fw fa-check-circle txt-success"></i></button></li>';c+='<li class="pull-right"><button data-action="toolbar-load" data-active="false" title="Edit Another File"><i class="fa fa-fw fa-image"></i></button></li>';c+='<li class="pull-right cloak"><button data-action="toolbar-help-close" data-active="false" title="Close"><i class="fa fa-fw fa-times-circle"></i></button></li>';c+="</ul>";c+="</div>";c+='<div class="sc-dropzone">';c+='<div class="sc-dropzone-msg">';c+='<h1><i class="fa fa-arrow-circle-o-down"></i><span class="sc-status">Drag Image Here.</span></h1>';c+='<input type="file" class="sc-file-upload" name="ghost-file" readonly="readonly">';c+='<input type="text" style="width:1px;" class="sc-file-blob" required="'+self.options.required+'" name="real-file">';c+="</div>";c+="</div>";c+='<div class="sc-workarea">';c+='<div class="sc-help">';c+="<ul>";c+='<li><i class="fa fa-fw fa-rotate-left"></i> Rotate Image Left</li>';c+='<li><i class="fa fa-fw fa-rotate-right"></i> Rotate Image Right</li>';c+='<li><i class="fa fa-fw fa-search-plus"></i> Zoom In</li>';c+='<li><i class="fa fa-fw fa-search-minus"></i> Zoom Out</li>';c+='<li><i class="fa fa-fw fa-eye"></i> Preview Crop</li>';c+='<li><i class="fa fa-fw fa-eye-slash"></i> Close Preview</li>';c+='<li><i class="fa fa-fw fa-ban"></i> Reset Crop</li>';c+='<li><i class="fa fa-fw fa-check-circle txt-success"></i> Save Cropped Image</li>';c+='<li><i class="fa fa-fw fa-image"></i> Edit Another File</li>';c+="</ul>";c+="</div>";c+='<div class="sc-preview-thumb"></div>';c+='<div class="sc-preview-wrap cloak">';c+='<div class="sc-preview-crop"></div>';c+="</div>";c+='<div class="sc-img-container">';c+="</div>";c+="</div>";$(el).html(c)};(function($){$.fn.savviCrop=function(options,callback){this.each(function(){var savviCrop=new SavviCrop(options,this,callback);return savviCrop})}})(jQuery);$(document).ready(function(){var args={required:true};$(".savvi-crop").savviCrop(args)});
